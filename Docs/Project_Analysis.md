# pyJianYingDraft：能力边界与工作流设计报告

基于对项目源码 (`pyJianYingDraft`) 及文档的深度分析，本文档旨在明确该工具的能力边界，并据此设计高效的自动化工作流。

## 1. 项目介绍与核心定位

**pyJianYingDraft** 是一个用于自动化生成和导出“剪映 (JianYing)”草稿的 Python 库。
它的**核心逻辑**不是直接渲染视频（类似 FFmpeg），而是**构建草稿文件 (`draft_content.json`)**。这意味着它充当了“剪辑师助手”的角色：它负责通过代码精细地安排时间轴，然后指挥剪映（宿主软件）完成最终的渲染。

## 2. 能力边界 (Capability Boundaries)

明确“能做什么”和“不能做什么”是设计工作流的前提。

### ✅ 核心能力 (What it CAN do)

*   **草稿生成 (Draft Generation)**: 从零构建时间轴，支持：
    *   **多轨道管理**: 视频、音频、文本、贴纸、特效、滤镜轨道。
    *   **精细控制**: 设置入出点、播放速度、不透明度、旋转缩放、坐标位置。
    *   **关键帧 (Keyframes)**: 支持属性（如位置、透明度、音量）的动态变化。
    *   **特效与动画**: 添加剪映内置的入场/出场/循环动画、画面特效、气泡文字、花字。
    *   **蒙版 (Masks)**: 线性、圆形、爱心等蒙版支持。
*   **模板自动化 (Template Mode)**:
    *   **加载现有草稿**: 读取已有的草稿作为模板（仅限 v5.9 及以下版本）。
    *   **内容替换**: 自动替换模板中的视频/图片素材、修改文本内容，保留原有的特效和动画效果。
    *   **轨道提取**: 将一个草稿的轨道完整合并到另一个草稿中。
*   **音频同步 (Beat Sync)** (基于 `beat_detector.py`):
    *   利用 `librosa` 自动检测音乐节拍 (Beats)。
    *   将节拍数据写入草稿，辅助生成“卡点”视频。
*   **自动化导出 (Batch Export)**:
    *   通过 UI 自动化 (`uiautomation`) 控制剪映窗口进行导出（仅限 Windows）。

### ❌ 限制与约束 (What it cannot do / Constraints)

*   **渲染限制**: **无法脱离剪映软件独立导出视频**。必须依赖安装了剪映的 Windows 环境进行最终渲染。
*   **版本兼容性墙**:
    *   **模板加载限制**: 不支持剪映 v6.0+ 创建的草稿（因 `draft_content.json` 被加密）。**可以通过降级剪映版本制作模板来绕过。**
    *   **导出控制限制**: 不支持剪映 v7.0+ 的自动化导出（因 UI 控件结构变化）。需保持剪映 v6.x 或 v5.x 版本用于导出节点。
*   **跨平台限制**: 自动化导出功能仅限 Windows。Mac/Linux 仅能生成草稿文件，无法自动化操作 UI 导出。

---

## 3. 基于能力的工作流设计 (Workflow Design)

基于上述能力，设计三种针对不同场景的自动化工作流：

### 🔄 工作流一：模板工厂 (The Template Factory)
**适用场景**: 批量生产结构固定、内容变化的视频（如：新闻播报、电商带货、每日语录）。

1.  **模板制作 (Manual)**:
    *   使用 **剪映 v5.9** 人工制作一个精美的“母版草稿”。
    *   预设好所有复杂的特效、转场、花字和背景音乐。
    *   为需要替换的素材命名（如 `slot_product_1`, `text_title_main`）。
2.  **数据注入 (Injection)**:
    *   Python 脚本读取数据源（Excel 表格、数据库或 API）。
    *   使用 `DraftFolder` 加载母版。
    *   调用 `replace_material_by_name` 替换图片/视频。
    *   调用 `replace_text` 替换文案。
3.  **批量生产 (Batch Build)**:
    *   循环生成 `product_01.json`, `product_02.json` 等草稿。
4.  **自动渲染 (Auto Export)**:
    *   脚本调用 `Jianying_controller`，指挥剪映逐个打开草稿并导出。

### 🎹 工作流二：节奏大师 (The Rhythm Master)
**适用场景**: 音乐卡点视频、快节奏混剪。

1.  **音频分析 (Analyze)**:
    *   输入 BGM 音频文件。
    *   调用 `BeatDetector.process(bpm=...)` 提取节拍时间点。
2.  **素材切片 (Slicing)**:
    *   Python 脚本准备素材库（一堆视频片段）。
    *   根据节拍时间点，动态计算每个片段的持续时长 (`duration = beat[i+1] - beat[i]`)。
    *   创建 `VideoSegment` 并对齐到节拍点。
3.  **特效注入 (Effects)**:
    *   在强拍位置（Downbeat）自动添加“震动”或“闪白”特效。
    *   在转场点自动添加 `TransitionType.叠化` 或 `TransitionType.闪黑`。
4.  **生成导出**: 生成卡点草稿 -> 自动导出。

### 🧠 工作流三：代码导演 (The Code Director)
**适用场景**: 数据可视化、动态解说、完全程序化生成的视频。

1.  **逻辑编排 (Scripting)**:
    *   纯代码定义时间轴逻辑（例如：前 3 秒显示标题，第 3-8 秒显示图表 A，第 8-15 秒显示图表 B）。
2.  **动态构建 (Construction)**:
    *   `script = ScriptFile(1920, 1080)`
    *   `script.add_track(...)`
    *   利用代码逻辑，动态计算关键帧 (`add_keyframe`) 实现复杂的动画效果（如图片随数据变化而移动/缩放）。
3.  **合成 (Synthesis)**:
    *   结合 TTS（文本转语音）生成的音频，自动根据语音长度调整画面停留时间。
    *   生成草稿 -> 自动导出。

## 4. 总结

`pyJianYingDraft` 是一个强大的**中间件**。它打通了 **Python 的数据处理能力** 与 **剪映的渲染能力**。
**最佳实践**是：
*   用 Python 处理逻辑、数据、逻辑控制和重复性劳动。
*   用 剪映 处理渲染、特效渲染和最终画质输出。
*   **坚守 v5.9/v6.0 版本**以确保工作流的完整闭环。
